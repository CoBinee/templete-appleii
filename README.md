# AppleII 向けにゲームをつくるための準備

[![Templete](http://img.youtube.com/vi/-e1odH8IzAk/0.jpg)](https://www.youtube.com/watch?v=-e1odH8IzAk)

## SIDELOAD
Releases にある templete-xxx.dsk ファイルをダウンロード、[Apple\]\[js](https://www.scullinsteel.com/apple2/) などの AppleII 環境で動かしてください。

## 開発
- [CC65](https://cc65.github.io)

## デモ
- ハイレゾグラフィックの一枚絵のファイルを VRAM に直接読み込んで表示。
- ハイレゾグラフィックへ用意したフォントでのテキスト描画。
- BEEP による単音の演奏。
- VRAM の内容をそのままファイルへの書き込み。
- 書き込んだファイルを再度 VRAM へ読み込んで表示。
- 7×8 ピクセル単位のタイルマップを `W` `A` `S` `D` のキー入力で方向を指定しての、全書き換えによるスクロール表示。
- 7×8 ピクセル単位のタイルマップにマスクパターンを使って重ね合わせを行ったタイルの表示。

## 忘備録

### AppleII
- 48KB のメモリ、1 台のフロッピーディスクドライブを搭載した AppleII がターゲット。

### 6502
- AppleII のクロック周波数は 1.023MHz（1.020484MHz）、単純計算で著名なファミコン 1.79MHz の約 60% の性能な上、グラフィックはビットマップを CPU で処理しなくてはならないので、はじめから割り切った仕様、設計とすると心にゆとりができる。
- 6502 そのものはシンプルな印象。
- 0 ページとアドレッシングの使い方が要、特に (indirect), y は活用したい。
- 構造体的にデータをまとめるのもいいが、absolute, x のアドレッシングを想定したデータ構成も有効。
- C フラグを伴った加減算命令しかなく、さらに Z80 とは減算時の C フラグが逆（ボローフラグ）の扱いになるので要注意。
- ロード命令で N と Z のフラグが変化するのは、結構使いやすい。

### メモリ
おおざっぱなメモリマップ。

| アドレス | 用途 |
| :--- | :--- |
| $0000 - $00FF | 0 ページ |
| $0100 - $01FF | スタック |
| $0200 - $02FF | 入力バッファ（モニタ ROM で使用） |
| $0300 - $03FF | 割り込みベクタなど |
| $0400 - $07FF | テキスト VRAM（ページ 1） |
| $0800 - $0BFF | テキスト VRAM（ページ 2） |
| $0C00 - $1FFF | フリーエリア |
| $2000 - $3FFF | ハイレゾグラフィック VRAM（ページ 1） |
| $4000 - $5FFF | ハイレゾグラフィック VRAM（ページ 2） |
| $6000 - $95FF | フリーエリア |
| $9600 - $9CFF | ディスク I/O バッファ |
| $9D00 - $BFFF | DOS ルーチン |
| $C000 - $C0FF | I/O ポート |
| $C100 - $CFFF | スロット |
| $D000 - $F7FF | BASIC など |
| $F800 - $FFFF | モニター ROM |

- フリーエリアは $0C00 - $1FFF の 5KB と $6000 - $95FF の 13KB の、計 18KB、もっとほしい。
- ハイレゾグラフィックを使うならばテキスト VRAM は不要だが、MIX モードを使ってデバッグなどするときにテキスト表示できると便利なので、ページ 1 は残してページ 2 はフリーエリアとする。
- ハイレゾグラフィックもページ切り替えとかはしないことにして、ページ 2 をフリーエリアとする。
- こうしてフリーエリアを $0800 - $1FFF の 6KB と $4000 - $95FF の 21KB の、計 27KB まで確保。
- $0800 - $1FFF に初期化処理や基本的なルーチンを置いて、$4000 - $95FF にアプリケーションプログラムを置く。
- ディスクであることを活用してアプリケーションプログラムは読み替えを前提にする。

### 0 ページ
資料によって異なる感じだけど、おおざっぱな 0 ページの使用状況。

|  | $00 | $01 | $02 | $03 | $04 | $05 | $06 | $07 | $08 | $09 | $0A | $0B | $0C | $0D | $0E | $0F |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| $00 | A | A | A | A | A | A |  |  |  |  | A | A | A | A | A | A |
| $10 | A | A | A | A | A | A | A | A | A |  |  |  |  |  |  |  |
| $20 | M | M | M | M | M | M | MD | MD | M | M | MD | MD | MD | MD | MD | MD |
| $30 | M | M | M | M | M | MD | MD | MD | MD | MD | M | M | M | M | MD | MD |
| $40 | MD | MD | MD | MD | MD | MD | MD | MD | MD | M | ID | ID | ID | ID |  |  |
| $50 | MA | MA | MA | MA | MA | MIA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA |
| $60 | IA | IA | IA | IA | IA | IA | IA | IAD | IAD | IAD | IAD | IA | IA | IA | IA | IAD |
| $70 | IAD | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA |
| $80 | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA |
| $90 | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA |
| $A0 | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IAD |
| $B0 | IAD | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA |
| $C0 | IA | IA | IA | IA | IA | IA | IA | IA | IA | IA | IAD | IAD | IAD | IAD | I | I |
| $D0 | IA | IA | IA | IA | IA | IA | I | I | IAD | IA | IA | IA | IA | IA | IA | IA |
| $E0 | A | A | A | A | A | A | A | A | A | A | A |  |  |  |  |  |
| $F0 | A | A | A | A | A | A | A | A | A |  |  |  |  |  |  |  |

- M : モニターROM、I : Integer BASIC、A : Applesoft BASIC、D : DOS
- 6502 は 0 ページの使い方が要、と書いたが、モニター ROM や DOS、BASIC がいろいろ使用しているので、フル活用は難しい。
- $00 - $1F と $E0 - $FF がひとまずのフリーエリア、さらに必要な場合は $80 - $9F あたりを候補に。

### Apple DOS 3.3
- ProDOS ではなくまずは Apple DOS 3.3 とする。
- INIT でディスクをフォーマット。その際、ディスクには DOS が書き込まれるので、純粋なブランクディスクとはならないみたい。
- フォーマットされたディスクはブート時に HELLO というファイル名を実行する（MS-DOS の autoexec.bat みたいなもの）。
- HELLO をバイナリの実行ファイルとしたかったけど、いま用意している環境だとどうしても BASIC ファイルでしか認識しなかったので、次のような BASIC コードを HELLO として、BOOT というファイル名をロード、実行するように。

    ```
    10 PRINT CHR$(4);"BRUN BOOT"
    ```

- BOOT は $0803 に読み込まれて実行。$0800 でも問題ないのだろうけど、ProDOS が $0800 - $0802 にベクタか何かを、みたいなことを書かれたのを見かけた記憶や、CC65 が用意する cfg ファイルのスタートアドレスも $0803 なので、流儀として。
- ファイル名は 30 文字まで。ただし DOS コールでパラメータにファイル名を設定するときは NULL 終端ではなく、残りは $20 のスペースで埋める。

### キーボード
- 押した瞬間しかキーコードを取得できない FM-7 仕様。
- `REPT` キーを押すと直前のキーに対してリピートがかかるようだけど、RPG っぽい移動で押しっぱなしな操作で使えるのか？
- いわゆる `5` キーで停止か、移動し続けるのを踏まえたゲームデザインが妥当そう。
- カーソルキーは `←` `→` のみ、移動の操作は今風ならば `W` `A` `S` `D` だけど、右手で操作が昔風というかしっくりなので `I` `J` `K` `L` も。
- Ultima は `RETURN` `←` `/` `→`。

### ハイレゾグラフィック
- 280x192 ピクセル、というよりも 140x192 ピクセルの解像度、として扱うのが賢そう。
- 6 色までを 1 プレーンで表現できるのは、癖はあるけどアクセスするメモリの大きさが少なく済むのは処理負荷的にありがたい。
- 8 ライン毎、また 64 ライン毎にアドレスの配置が変則的になるので、タイルマップ的なゲームがよさそう。

### BEEP
- $C030 にアクセスすると 1-bit スピーカーが鳴るだけの仕組みなので、音階を奏でるには音の周波数に合わせてスピーカーの ON/OFF の間隔を制御する。
- $C030 へのアクセスでトグル的に ON/OFF されるとのことだが、6502 が STA で書き込みする場合はその際に一度読み込みのアクセスが入るので、STA だと ON→OFF とすぐに音が止まる、という記述がどこかにあり、アクセスは LDA とか BIT とかがよいようだ。
- だたし AppleIIjs だと LDA でも STA でも ON→OFF の挙動をするし、CT6502 はうまく鳴らなかったりと、AppleII の実機ではどういう動作をするのか知りたいところ。

